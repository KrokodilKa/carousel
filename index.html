<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<!--    <meta http-equiv="X-UA-Compatible" content="ie=edge">-->
    <link rel="stylesheet" href="style.css">
    <title>Document</title>
</head>
    <body>
        <section id="carousel">
            <div id="stock" style="left: 0px">
                <div class="blackBlind"></div>
                <img id="img"/>
                <div class="blackBlind"></div>
            </div>
        </section>
        <section id="scheme"></section>
        <button style="display: none" id="btn">отладка</button>
        <h3 style="display: none" id="indicator">картинка загружена</h3>

        <script>
            //Запретить браузерам захватывать картинку мышью (тапом) и перетаскивать её.
            document.getElementById("img").onmousedown = e => e.preventDefault()
            document.getElementById("img").ontouchstart = e => e.preventDefault()

            let current = 0

            const carousel = document.getElementById("carousel")
            const stock = document.getElementById("stock")
            const btn = document.getElementById("btn")
            const scheme = document.getElementById("scheme")
            let pointer

            //Мы не можем прокрутить дальше высчитанного значения
            let leftStop
            let rightStop
            // Захват говорит о том, что сейчас отображается чёрная шторка и грузится картинка. Значит нам нужно сохранить значение скорости и не трогать его.
            let capture = false
            let canChangeImg = true

            let focusLine
            let stopWidth = 0
            const stationslist = [
                {
                    name: "Мичуринский проспект",
                    img: "./images/0.jpg",
                },
                {
                    name: "Проспект Вернадского",
                    img: "./images/1.jpg"
                },
                {
                    name: "Воронцовская",
                    img: "./images/2.jpg"
                },
                {
                    name: "Зюзино",
                    img: "./images/3.png"
                }
            ]

            function getStopWidth () {
                let stopWidth = Math.floor(Number(stock.style.width.slice(0, -2)) / 2) - Math.floor(carousel.offsetWidth / 2)
                leftStop = stopWidth
                rightStop = -1 * stopWidth
                console.log(leftStop)
                console.log(rightStop)
            }
            function setStockWidth () {
                let current = document.getElementById("img")
                stock.style.width = (current.offsetWidth + (2 * document.getElementsByClassName("blackBlind")[0].offsetWidth)) + "px"
            }
            function createImage () {
                console.log("вызывается новая картинка. курент " + current)
                //Подгружает нужную картинку и ставит в тег img
                capture = true
                document.getElementById("indicator").textContent = "грузится картинка"
                let img = new Image();
                img.onload = function() {
                    img.setAttribute(
                        'style',
                        `
                            background-image:url(${img.src});
                            height: 100%
                        `,
                    );
                    //Смена картинки происходит ТОЛЬКО когда значение left === stopValue
                    if (leftStop === Math.abs(Number(stock.style.left.slice(0, -2)))) {
                        console.log("мы находимся у края")
                        let end
                        if (Number(stock.style.left.slice(0, -2)) == leftStop) {
                            end = "right"
                        }
                        console.log(leftStop === Math.abs(Number(stock.style.left.slice(0, -2))))
                        document.getElementById("img").src = img.src
                        setStockWidth ()
                        getStopWidth ()
                        if (end == "right") {
                            //Мы были слева - подгрузим нас справа
                            console.log("Я гружу вас справа. С отрицательным значением " + rightStop)
                            stock.style.left = rightStop + 5 + "px"
                        } else {
                            //Мы были справа - подгрузим нас слева
                            stock.style.left = leftStop - 5 + "px"
                        }
                    }
                    capture = false
                    document.getElementById("indicator").textContent = "картинка загружена"
                }
                img.src = stationslist[current].img;
            }
            function setNewNumberOfStation (symbol) {
                //Проверяем нужно ли нам сделать переход по разрыву в кольце станций (разрыв - переход от начала к концу)
                console.log("symbol")
                console.log(symbol)
                if (symbol == "1") {
                    if (current + 1 > stationslist.length - 1) {
                        console.log(current + 1 > stationslist.length - 1)
                        current = 0
                    } else {
                        console.log("pluse")
                        current = current + 1
                    }
                } else if (symbol == "-1") {
                    if (current === 0) {
                        current = stationslist.length - 1
                    } else {
                        current = current - 1
                    }
                }
                console.log(current)
                createImage()
            }


        </script>
        <script src="./listeners.js"></script>
        <script src="./scheme.js"></script>
        <script src="./first.js"></script>
    </body>
</html>
